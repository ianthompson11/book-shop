{% extends "payments/base.html" %}
{% load static %}

{% block title %}Compra exitosa{% endblock %}

{% block styles %}
  <!-- Incluyo el CSS específico para animación de ganchito -->
  <link rel="stylesheet" href="{% static 'payments/css/checkmark.css' %}">
{% endblock %}

{% block blurred_card %}
    <!-- Cambié text-white por text-black -->

    <header class="mb-6 text-center flex items-center justify-center space-x-3">
      <!-- SVG animado del check -->
      <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
        <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
        <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
      </svg>

      <!-- Texto -->
      <h1 class="text-3xl font-bold text-black">¡Compra completada!</h1>
    </header>

    <p class="mt-2 text-sm text-black text-center">Tu transacción fue procesada correctamente.</p>

    <div class="text-sm space-y-2 mt-4">
      <p><span class="font-semibold">ID de transacción:</span> {{ transaction_id }}</p>
      <p><span class="font-semibold">Estado:</span> {{ status }}</p>
    </div>

    <div class="mt-6">
      <a href="/productos"
         class="w-full block text-center py-2 px-4 bg-yellow-500 hover:bg-yellow-600 text-black font-semibold rounded-lg shadow-md transition">
         Volver al inicio
      </a>
    </div>

    <script>
      // Asegurar que el carrito esté completamente limpio después de una compra exitosa
      function clearCart() {
        // Obtener el carrito principal y el carrito de compra
        const mainCart = JSON.parse(localStorage.getItem("cart")) || [];
        const purchasedCart = JSON.parse(localStorage.getItem("cart_checkout")) || [];
        
        if (purchasedCart.length > 0) {
          // Remover los productos comprados del carrito principal
          const updatedMainCart = mainCart.filter(mainItem => {
            return !purchasedCart.some(purchasedItem => 
              purchasedItem.sku === mainItem.sku
            );
          });
          
          // Actualizar el carrito principal sin los productos comprados
          if (updatedMainCart.length > 0) {
            localStorage.setItem("cart", JSON.stringify(updatedMainCart));
          } else {
            localStorage.removeItem("cart");
          }
        } else {
          // Si no hay carrito de compra, limpiar todo (fallback)
          localStorage.removeItem("cart");
        }
        
        // Limpiar siempre los carritos temporales
        localStorage.removeItem("cart_selected");
        localStorage.removeItem("cart_checkout");
        
        // También limpiar cualquier contador de carrito que pueda estar visible
        const cartCount = document.getElementById("cart-count");
        if (cartCount) {
          const remainingCart = JSON.parse(localStorage.getItem("cart")) || [];
          cartCount.textContent = remainingCart.length > 0 ? `(${remainingCart.length})` : '';
        }
        
        console.log("Productos comprados removidos del carrito principal");
      }
      
      // Ejecutar al cargar la página
      clearCart();
    </script>
{% endblock %}





